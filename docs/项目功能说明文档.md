# CMS-Copilot 项目功能说明文档

## 项目概述

CMS-Copilot 是一个基于 **LangGraph** 的内容/站点运营 Copilot 系统，将"意图识别 → 任务分流 → 工具调用（含 MCP）→ 结果输出"串成一张可在 **LangGraph Studio** 可视化调试的工作流图。

---

## 核心功能模块

### 1. RAG 知识库问答

**功能描述**：支持 SSE 流式输入输出，提供"准备 + 生成"双阶段进度 UI 展示。

**关键节点**：
- `start_rag_ui`：初始化 RAG 工作流 UI 卡片
- `handle_rag`：处理知识库检索请求，支持流式输出

**工作流程**：
1. 用户输入问题
2. 系统调用外部 RAG 服务（SSE 流式）
3. 实时展示"准备"和"生成"两个阶段的进度
4. 逐 token 流式输出答案

---

### 2. 文章任务（Article）

**功能描述**：支持参数自动提取与多轮澄清，执行文章生成/处理类任务。

**关键节点**：
- `article_clarify` 子图：参数收集与澄清流程
- `article_ui`：文章工作流 UI 初始化
- `article_run`：执行远程文章生成工作流

**支持的参数**：
- `topic`：文章主题
- `content_format`：内容格式
- `target_audience`：目标受众
- `tone`：文章风格
- `app_id` / `app_name`：应用配置

---

### 3. SEO 规划

**功能描述**：基于 GA 数据输出 SEO 周任务规划与建议。

**关键节点**：
- `start_seo_ui`：SEO 规划 UI 初始化
- `handle_seo`：调用 SEO 分析服务

**输出内容**：
- 周任务计划（按日期、优先级排列）
- 问题分类（Indexing、OnPage、Performance、Content、StructuredData）
- 严重程度标记（critical、warning、info）
- 修复建议与工作流关联

---

### 4. 站点报告（Report）

**功能描述**：调用 GA MCP 工具生成可视化站点数据报告。

**关键节点**：
- `start_report_ui`：报告 UI 初始化
- `report_init`：拉取 MCP 工具列表，判断意图
- `report_execute_tool`：Planning + Execution 模式批量执行
- `report_render_charts`：推送图表数据到前端
- `report_ask_insights`：询问用户是否生成洞察分析

**报告类型**：
- 综合概览（overview）
- 流量分析（traffic）
- 内容分析（content）
- 用户互动（engagement）
- 性能分析（performance）

**输出结构**：
- `summary`：核心指标摘要
- `charts`：图表数据（支持 line/bar/pie）
- `data_quality`：数据质量提示
- `insights`：AI 洞察解读
- `actions`：建议动作
- `todos`：可执行待办

---

### 5. 快捷指令（Shortcut）

**功能描述**：用更"命令式"的方式完成常用动作，支持人工确认。

**关键节点**：
- `shortcut_init`：初始化，拉取 MCP 工具列表
- `shortcut_plan`：生成多步执行计划
- `shortcut_prepare_step`：设置当前步骤
- `shortcut_confirm_step`：风险步骤确认（HITL）
- `shortcut_execute_step`：执行当前步骤
- `shortcut_finalize`：汇总展示结果

**特性**：
- 支持能力询问（"能做什么"）
- 多步执行计划（Plan → Execute）
- 风险操作需人工确认
- 工具缓存机制

---

## 前端组件说明

所有 UI 组件位于 `src/ui/ui.tsx`，采用 **Generative UI** 模式，通过 `push_ui_message` 与后端状态同步。

### 基础组件

#### Badge

```tsx
const Badge: React.FC<{
  children?: React.ReactNode;
  tone?: "slate" | "blue" | "green" | "red";
}> = ({ children, tone = "slate" }) => {
  const tones: Record<string, { bg: string; fg: string; bd: string }> = {
    slate: { bg: "#f1f5f9", fg: "#334155", bd: "#e2e8f0" },
    blue: { bg: "#eff6ff", fg: "#1d4ed8", bd: "#bfdbfe" },
    green: { bg: "#ecfdf5", fg: "#047857", bd: "#a7f3d0" },
    red: { bg: "#fff1f2", fg: "#be123c", bd: "#fecdd3" },
  };
  // ... 渲染胶囊徽章
};
```

**用途**：状态标签展示（进行中、已完成、失败等）

---

#### Spinner

```tsx
const Spinner: React.FC = () => {
  return (
    <span
      className="lgui-spin"
      style={{
        display: "inline-block",
        width: 12,
        height: 12,
        borderRadius: "50%",
        border: "2px solid #dbeafe",
        borderTopColor: "#2563eb",
      }}
    />
  );
};
```

**用途**：加载动画指示器

---

### 业务组件

#### IntentRouterCard

```tsx
type IntentRouterProps = {
  status: "thinking" | "done" | "error";
  user_text?: string;
  intent?: string;
  route?: string;
  raw?: string;
  elapsed_s?: number | null;
  steps?: string[];
  active_step?: number;
  rag_status?: "running" | "done" | "error";
  rag_message?: string;
};
```

**用途**：意图识别进度卡片

**功能**：
- 显示意图识别状态（thinking/done/error）
- 展示识别结果（intent 和 route）
- 显示思考耗时
- 支持展开查看用户输入和模型原始输出

**后端推送示例**：
```python
push_ui_message(
    name="intent_router",
    props={
        "status": "done",
        "intent": "rag",
        "route": "rag_ui",
        "elapsed_s": 1.5,
    },
    ui_id=ui_id,
    anchor_id=anchor_id,
    merge=True,
)
```

---

#### RAGWorkflowCard

```tsx
type RAGWorkflowProps = {
  status: "running" | "done" | "error";
  session_id?: string | null;
  tabs?: RAGTab[];
  active_tab?: RAGTabKey;
  steps?: {
    prep?: RAGStep[];
    generate?: RAGStep[];
  };
  error_message?: string | null;
};

type RAGStep = {
  key?: string;
  title?: string;
  status?: "pending" | "running" | "done" | "error";
  message?: string;
};
```

**用途**：知识库检索工作流进度卡片

**功能**：
- 分"准备"和"生成"两个阶段展示
- 每个阶段支持多个步骤
- 实时状态更新（pending → running → done）
- 错误信息展示

**后端推送示例**：
```python
push_ui_message(
    name="rag_workflow",
    props={
        "status": "running",
        "session_id": "abc123",
        "steps": {
            "prep": [
                {"key": "retrieve", "title": "检索文档", "status": "running"},
            ],
            "generate": [
                {"key": "answer", "title": "生成答案", "status": "pending"},
            ],
        },
    },
    ui_id=ui_id,
    anchor_id=anchor_id,
    merge=True,
)
```

---

#### ArticleWorkflowCard

```tsx
type ArticleWorkflowProps = {
  status: "running" | "done" | "error";
  run_id?: string | null;
  thread_id?: string | null;
  current_node?: string | null;
  flow_node_list?: WorkflowNode[];
  error_message?: string | null;
};

type WorkflowNode = {
  node_code?: string;
  node_name?: string;
  node_status?: string;
  node_message?: string;
};
```

**用途**：文章生成工作流进度卡片

**功能**：
- 展示工作流节点列表
- 标记当前执行节点
- 节点状态点显示（RUNNING/SUCCESS/FAILED）
- 支持节点消息展示

---

#### ArticleClarifyCard

```tsx
type ArticleClarifyProps = {
  status: "need_info" | "done" | "error";
  missing?: string[];
  question?: string;
  topic?: string;
  content_format?: string;
  target_audience?: string;
  tone?: string;
  tone_options?: string[];
  app_id?: string;
  app_name?: string;
  app_options?: AppOption[];
  model_id?: string;
};
```

**用途**：文章参数补充表单卡片

**功能**：
- 交互式表单收集文章参数
- 下拉选择支持（风格、应用）
- 缺失字段提示
- 提交后自动发送消息继续对话

**关键实现**：
```tsx
// sendMessage 函数：兼容多种环境发送消息
const sendMessage = (text: string) => {
  const win = window as any;
  // 1. 尝试全局注入函数
  const globalFns = ["__LANGGRAPH_SEND_MESSAGE__", "sendMessage"];
  for (const fn of globalFns) {
    if (typeof win[fn] === "function") {
      win[fn](text);
      return;
    }
  }
  // 2. 自定义事件
  window.dispatchEvent(new CustomEvent("langgraph:send", { detail: { text } }));
  // 3. DOM 操作兜底
  // ...
};
```

---

#### MCPWorkflowCard

```tsx
type MCPWorkflowProps = {
  status: "select" | "confirm" | "running" | "done" | "cancelled" | "error";
  title?: string;
  message?: string;
  options?: MCPOption[];
  selected?: MCPOption | null;
  recommended?: string | null;
  result?: string | null;
  company_name?: string | null;
  logo_url?: string | null;
};

type MCPOption = {
  code?: string;
  name?: string;
  desc?: string;
};
```

**用途**：MCP/Shortcut 工作流卡片

**功能**：
- 多状态流转（select → confirm → running → done）
- 选项列表展示和选择
- 确认/取消按钮（HITL）
- 执行结果展示

**interrupt 恢复机制**：
```tsx
const resumeInterrupt = (value: any) => {
  const win = window as any;
  // 1. LangGraph Studio 注入函数
  if (typeof win.__LANGGRAPH_RESUME__ === "function") {
    win.__LANGGRAPH_RESUME__(value);
    return;
  }
  // 2. Agent Chat UI 函数
  // 3. 自定义事件
  window.dispatchEvent(new CustomEvent("langgraph:resume", { detail: value }));
};
```

---

#### SEOPlannerCard

```tsx
type SEOPlannerProps = {
  status: "loading" | "done" | "error";
  step?: string;
  user_text?: string;
  steps?: string[];
  active_step?: number;
  tasks?: SEOWeeklyPlanData | null;
  error_message?: string | null;
};

type SEOTask = {
  date?: string;
  day_of_week?: string;
  category?: string;
  issue_type?: string;
  title?: string;
  description?: string;
  impact?: number;
  difficulty?: number;
  severity?: string;
  requires_manual_confirmation?: boolean;
  workflow_id?: string;
  params?: Record<string, any>;
  evidence?: SEOTaskEvidence[];
  fix_action?: "article" | "link" | "none";
  fix_prompt?: string;
};
```

**用途**：SEO 周任务规划卡片

**功能**：
- 分析进度步骤展示
- 按日期分组的任务列表
- 任务分类颜色标记
- 严重程度标签（critical/warning/info）
- 影响和难度评分展示

---

#### SiteReportCard

```tsx
type SiteReportProps = {
  status: "loading" | "done" | "error";
  step?: string;
  user_text?: string;
  message?: string;
  steps?: string[];
  active_step?: number;
  report?: {
    site_id?: string;
    report_type?: "overview" | "traffic" | "content" | "engagement" | "performance";
    report_type_name?: string;
    summary?: { /* 核心指标 */ } | null;
    charts?: { /* 图表数据 */ };
    data_quality?: { /* 数据质量 */ } | null;
    insights?: { /* AI 洞察 */ } | null;
    actions?: { /* 建议动作 */ }[] | null;
    todos?: { /* 可执行待办 */ }[] | null;
  } | null;
  error_message?: string | null;
};
```

**用途**：站点报告综合卡片

**功能**：
- 多种报告类型（overview/traffic/content/engagement/performance）
- 报告类型图标和颜色区分
- 核心指标摘要展示（访问量、跳出率、会话时长等）
- 图表数据透传（由外部前端项目渲染）
- AI 洞察和建议动作展示
- 数据质量提示

---

#### Report v2 三卡分离组件

```tsx
// 进度卡片
type ReportProgressProps = {
  status: "loading" | "done" | "error";
  step?: string;
  user_text?: string;
  steps?: string[];
  active_step?: number;
  message?: string;
  error_message?: string | null;
};

// 图表卡片
type ReportChartsProps = {
  status: "loading" | "done" | "error";
  message?: string;
  report?: {
    summary?: any;
    charts?: any;
  } | null;
};

// 洞察卡片
type ReportInsightsProps = {
  status: "loading" | "done" | "error";
  message?: string;
  report?: any;
};

// 洞察确认卡片
type ReportConfirmInsightsProps = {
  message?: string;
};
```

**用途**：Report v2 版本的分离式卡片

**设计理念**：
- `ReportProgressCard`：仅展示进度
- `ReportChartsCard`：仅展示图表和摘要
- `ReportInsightsCard`：仅展示洞察分析
- `ReportConfirmInsightsCard`：HITL 确认是否生成洞察

---

#### ShortcutSelectCard & ShortcutConfirmCard

```tsx
type ShortcutSelectProps = {
  title?: string;
  message?: string;
  options?: { code?: string; name?: string; desc?: string }[];
  recommended?: string | null;
};

type ShortcutConfirmProps = {
  title?: string;
  message?: string;
  selected?: any;
  params?: any;
};
```

**用途**：Shortcut 流程的选择和确认卡片

**功能**：
- 选项列表展示
- 推荐选项标记
- 确认/取消操作
- 使用 `streamCtx.resume()` 恢复 interrupt

---

## 组件映射表

```tsx
const ComponentMap = {
  intent_router: IntentRouterCard,
  rag_workflow: RAGWorkflowCard,
  article_workflow: ArticleWorkflowCard,
  article_clarify: ArticleClarifyCard,
  article_clarify_summary: ArticleClarifySummaryCard,
  mcp_workflow: MCPWorkflowCard,
  seo_planner: SEOPlannerCard,
  site_report: SiteReportCard,
  report_progress: ReportProgressCard,
  report_progress_insights: ReportProgressCard,
  report_charts: ReportChartsCard,
  report_insights: ReportInsightsCard,
  report_confirm_insights: ReportConfirmInsightsCard,
  shortcut_select: ShortcutSelectCard,
  shortcut_confirm: ShortcutConfirmCard,
  card: IntentRouterCard, // 兼容旧名字
};

export default ComponentMap;
```

---

## 状态管理

### CopilotState（主图状态）

```python
class CopilotState(TypedDict):
    # 消息列表
    messages: Annotated[Sequence[BaseMessage], add_messages]
    ui: Annotated[Sequence[AnyUIMessage], ui_message_reducer]
    
    # 网站相关
    tenant_id: str | None
    site_id: str | None
    site_host: str | None
    oauth_token: str | None
    
    # 意图识别
    intent: str | None
    intent_ui_id: str | None
    intent_anchor_id: str | None
    
    # 各模块 UI ID
    rag_ui_id: str | None
    article_ui_id: str | None
    seo_ui_id: str | None
    report_ui_id: str | None
    shortcut_ui_id: str | None
    
    # 跳转控制
    resume_target: str | None
    direct_intent: str | None
    
    # 文章澄清
    article_clarify_pending: bool | None
    article_topic: str | None
    # ...
```

### ShortcutState（Shortcut 子图状态）

```python
class ShortcutState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], add_messages]
    ui: Annotated[Sequence[AnyUIMessage], ui_message_reducer]
    
    # Plan → Execute 流程
    user_text: str | None
    tools: list[dict[str, Any]] | None
    is_capability_inquiry: bool | None
    plan_steps: list[dict[str, Any]] | None
    current_step_idx: int | None
    current_step: dict[str, Any] | None
    step_outputs: list[dict[str, Any]] | None
    pending_decision: dict[str, Any] | None
    cancelled: bool | None
    error: str | None
```

### ReportState（Report 子图状态）

```python
class ReportState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], add_messages]
    ui: Annotated[Sequence[AnyUIMessage], ui_message_reducer]
    
    # GA 相关
    property_id: str | None
    report_type: str | None
    report_type_name: str | None
    period: dict[str, Any] | None
    
    # 洞察层
    evidence_pack: dict[str, Any] | None
    data_quality: dict[str, Any] | None
    insights: dict[str, Any] | None
    actions: list[dict[str, Any]] | None
    todos: list[dict[str, Any]] | None
    
    # MCP 工具调用
    tool_specs: list[Any] | None
    tool_result: Any | None
    tool_error: str | None
```

---

## 技术栈

- **后端**：Python 3.12+、LangGraph、LangChain
- **前端**：React（TypeScript）、LangGraph SDK
- **工具**：MCP (Model Context Protocol)
- **数据源**：Google Analytics 4

---

## 开发指南

### 添加新意图/任务分支

1. 在 `src/agent/nodes/` 新增节点（或在 `src/agent/subgraphs/` 新增子图）
2. 在 `src/agent/graph.py` 中：
   - `builder.add_node(...)` 添加节点
   - 在 router 的条件边里增加 intent → node 映射
   - 连接到 `END` 或下一步节点
3. 在 `src/ui/ui.tsx` 中添加对应的 UI 组件
4. 在 `ComponentMap` 中注册组件

### 编写 UI 组件

```tsx
// 1. 定义 Props 类型
type MyComponentProps = {
  status: "loading" | "done" | "error";
  data?: any;
};

// 2. 编写组件
const MyComponentCard: React.FC<MyComponentProps> = (props) => {
  return (
    <div className="lgui-card" style={{...}}>
      <style>{cssText}</style>
      {/* 组件内容 */}
    </div>
  );
};

// 3. 注册到 ComponentMap
const ComponentMap = {
  // ...
  my_component: MyComponentCard,
};
```

### 后端推送 UI 更新

```python
from langgraph.graph.ui import push_ui_message

push_ui_message(
    name="my_component",  # 对应 ComponentMap 的 key
    props={
        "status": "done",
        "data": {...},
    },
    ui_id=ui_id,      # UI 卡片 ID
    anchor_id=anchor_id,  # 锚点消息 ID
    merge=True,       # 是否合并更新
)
```

---

## 目录结构

```
src/
  agent/
    graph.py              # 主图组装
    config.py             # 配置与环境变量
    state.py              # 状态定义
    nodes/                # 业务节点
      entry.py            # 入口节点
      router.py           # 意图路由
      rag.py              # RAG 知识库
      article.py          # 文章任务
      seo.py              # SEO 规划
      report.py           # 站点报告
      shortcut.py         # 快捷指令
    subgraphs/            # 子图
      article.py          # 文章澄清子图
      report.py           # 报告生成子图
      shortcut.py         # 快捷指令子图
    tools/                # 工具层
      mcp.py              # MCP 客户端
      ga_mcp.py           # GA MCP 工具
      rag.py              # RAG 工具
      seo.py              # SEO 工具
    utils/                # 通用工具
      llm.py              # LLM 封装
      helpers.py          # 辅助函数
  ui/
    ui.tsx                # Studio UI 组件
docs/
tests/
langgraph.json            # LangGraph 配置
```
